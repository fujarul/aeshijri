<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AES Crypto App — File Support</title>
  <style>
    :root{--bg:#0f172a;--card:#111827;--accent:#06b6d4;--muted:#9ca3af;--glass:rgba(255,255,255,0.03)}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Noto Sans',sans-serif;background:linear-gradient(180deg,#071024 0%, #04122a 100%);color:#e6eef8}
    .wrap{max-width:980px;margin:28px auto;padding:22px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    h1{margin:0 0 8px;font-size:20px}
    p.lead{margin:0 0 18px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:inset 0 1px 0 rgba(255,255,255,0.02)}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text],input[type=password],textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit;resize:vertical}
    textarea{min-height:120px}
    .row{display:flex;gap:8px}
    button{background:var(--accent);border:none;padding:10px 12px;border-radius:8px;color:#012;cursor:pointer;font-weight:600}
    .muted{color:var(--muted);font-size:13px}
    .result{word-break:break-all;background:rgba(0,0,0,0.2);padding:10px;border-radius:8px;margin-top:8px;max-height:200px;overflow:auto}
    .full{grid-column:1/-1}
    footer{margin-top:12px;color:var(--muted);font-size:13px}
    .small{font-size:12px}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>AES-GCM Web Crypto — Aplikasi Kriptografi (File PDF)</h1>
    <p class="lead">Enkripsi/dekripsi teks & file (mis. PDF) di browser. Kunci diturunkan dari password lewat PBKDF2. Semua operasi menggunakan Web Crypto API (tetap di browser).</p>

    <div class="grid">
      <!-- Left: plaintext / file encrypt -->
      <div class="card">
        <label for="plaintext">Plaintext (pesan) — atau pilih file untuk enkripsi</label>
        <textarea id="plaintext" placeholder="Tulis pesan yang ingin dienkripsi..."></textarea>

        <label for="fileToEnc">Atau pilih file (PDF, gambar, dll)</label>
        <input id="fileToEnc" type="file" accept="*/*" />

        <label for="password">Password</label>
        <input id="password" type="password" placeholder="Password untuk derive key" />

        <label for="iterations">PBKDF2 Iterations</label>
        <select id="iterations">
          <option value="100000">100,000 (default)</option>
          <option value="200000">200,000</option>
          <option value="500000">500,000</option>
        </select>

        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="encryptBtn">Encrypt</button>
          <button id="downloadEncBtn" disabled>Download Encrypted</button>
        </div>

        <div class="muted small" style="margin-top:10px">Output (base64):</div>
        <div id="encOutput" class="result">-</div>
      </div>

      <!-- Right: decrypt -->
      <div class="card">
        <label for="encInput">Encrypted (paste base64 here) — atau pilih file .enc</label>
        <textarea id="encInput" placeholder="Tempel data enkripsi di sini (base64)"></textarea>

        <label for="decPassword">Password untuk Decrypt</label>
        <input id="decPassword" type="password" placeholder="Masukkan password yang sama" />

        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="decryptBtn">Decrypt</button>
          <input id="fileEnc" type="file" accept="*/*" />
        </div>

        <div class="muted small" style="margin-top:10px">Decrypted text (untuk teks):</div>
        <div id="decOutput" class="result">-</div>
      </div>

      <div class="card full">
        <h3 style="margin-top:0">Penjelasan singkat</h3>
        <ul class="muted small">
          <li>Kunci AES-256-GCM diturunkan dari password menggunakan PBKDF2 SHA-256 (salt 16 byte acak).</li>
          <li>IV/nonce 12 byte acak per enkripsi.</li>
          <li>Untuk file, format: <code>salt(16) || iv(12) || "F1"(2) || filenameLen(2) || filename || ciphertext</code> lalu base64.</li>
          <li>Untuk teks, format tetap: <code>salt || iv || ciphertext</code> (kompatibel dengan versi teks sebelumnya).</li>
        </ul>
      </div>
    </div>

    <footer>Built with Web Crypto API — AES-GCM + PBKDF2. Untuk file besar, hati-hati dengan memori browser.</footer>
  </div>

  <script>
    // helper konversi
    const bufToBase64 = (buf) => btoa(String.fromCharCode(...new Uint8Array(buf)));
    const base64ToBuf = (b64) => Uint8Array.from(atob(b64), c => c.charCodeAt(0));

    const enc = new TextEncoder();
    const dec = new TextDecoder();

    async function deriveKey(password, salt, iterations=100000) {
      const baseKey = await crypto.subtle.importKey('raw', enc.encode(password), {name:'PBKDF2'}, false, ['deriveKey']);
      return crypto.subtle.deriveKey(
        {name:'PBKDF2', salt, iterations: Number(iterations), hash:'SHA-256'},
        baseKey,
        {name:'AES-GCM', length:256},
        false,
        ['encrypt','decrypt']
      );
    }

    async function encryptText(plaintext, password, iterations=100000) {
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const key = await deriveKey(password, salt, iterations);
      const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, enc.encode(plaintext));
      const combined = new Uint8Array(salt.byteLength + iv.byteLength + ct.byteLength);
      combined.set(salt, 0);
      combined.set(iv, salt.byteLength);
      combined.set(new Uint8Array(ct), salt.byteLength + iv.byteLength);
      return bufToBase64(combined.buffer);
    }

    async function encryptFile(arrayBuffer, filename, password, iterations=100000) {
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const key = await deriveKey(password, salt, iterations);
      const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, arrayBuffer);

      const nameBytes = enc.encode(filename);
      if (nameBytes.length > 0xFFFF) throw new Error('Filename terlalu panjang');

      const headerLen = 16 + 12 + 2 + 2 + nameBytes.length;
      const combined = new Uint8Array(headerLen + ct.byteLength);
      let offset = 0;
      combined.set(salt, offset); offset += salt.byteLength;
      combined.set(iv, offset); offset += iv.byteLength;
      combined.set(new Uint8Array([0x46, 0x31]), offset); offset += 2;
      combined[offset] = (nameBytes.length >> 8) & 0xFF;
      combined[offset+1] = nameBytes.length & 0xFF;
      offset += 2;
      combined.set(nameBytes, offset); offset += nameBytes.length;
      combined.set(new Uint8Array(ct), offset);
      return bufToBase64(combined.buffer);
    }

    async function decryptCombined(base64data, password, iterations=100000) {
      const combined = base64ToBuf(base64data);
      if (combined.length < 16 + 12 + 16) throw new Error('Data enkripsi tidak valid atau terlalu pendek');

      const salt = combined.slice(0,16);
      const iv = combined.slice(16, 28);

      if (combined.length >= 30 && combined[28] === 0x46 && combined[29] === 0x31) {
        let offset = 30;
        if (combined.length < offset + 2) throw new Error('Data enkripsi tidak valid');
        const nameLen = (combined[offset] << 8) | combined[offset+1];
        offset += 2;
        if (combined.length < offset + nameLen) throw new Error('Data enkripsi tidak valid');
        const nameBytes = combined.slice(offset, offset + nameLen);
        const filename = dec.decode(nameBytes);
        offset += nameLen;
        const ct = combined.slice(offset);
        const key = await deriveKey(password, salt, iterations);
        const plainBuf = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
        return { type:'file', filename, arrayBuffer: plainBuf };
      } else {
        const ct = combined.slice(28);
        const key = await deriveKey(password, salt, iterations);
        const plainBuf = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
        const text = dec.decode(plainBuf);
        return { type:'text', text };
      }
    }

    const encryptBtn = document.getElementById('encryptBtn');
    const decryptBtn = document.getElementById('decryptBtn');
    const plaintextEl = document.getElementById('plaintext');
    const passwordEl = document.getElementById('password');
    const iterationsEl = document.getElementById('iterations');
    const encOutput = document.getElementById('encOutput');
    const encInput = document.getElementById('encInput');
    const decPassword = document.getElementById('decPassword');
    const decOutput = document.getElementById('decOutput');
    const downloadEncBtn = document.getElementById('downloadEncBtn');
    const fileToEnc = document.getElementById('fileToEnc');
    const fileEnc = document.getElementById('fileEnc');

    let lastEncryptedBase64 = '';

    encryptBtn.addEventListener('click', async () => {
      try {
        const pwd = passwordEl.value;
        if (!pwd) return alert('Masukkan password');

        encryptBtn.disabled = true;
        encryptBtn.textContent = 'Encrypting...';

        const iterations = iterationsEl.value;
        const f = fileToEnc.files[0];
        let base64;
        if (f) {
          const arrayBuffer = await f.arrayBuffer();
          base64 = await encryptFile(arrayBuffer, f.name, pwd, iterations);
        } else {
          const text = plaintextEl.value;
          if (!text) return alert('Masukkan plaintext atau pilih file terlebih dahulu');
          base64 = await encryptText(text, pwd, iterations);
        }

        encOutput.textContent = base64;
        encInput.value = base64;
        lastEncryptedBase64 = base64;
        downloadEncBtn.disabled = false;
      } catch (e) {
        alert('Gagal enkripsi: ' + e.message);
      } finally {
        encryptBtn.disabled = false;
        encryptBtn.textContent = 'Encrypt';
      }
    });

    downloadEncBtn.addEventListener('click', () => {
      const data = lastEncryptedBase64 || encOutput.textContent.trim();
      if (!data) return;
      const blob = new Blob([data], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'encrypted.txt';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    fileEnc.addEventListener('change', async (e) => {
      const f = e.target.files[0];
      if (!f) return;
      const txt = await f.text();
      encInput.value = txt.trim();
    });

    decryptBtn.addEventListener('click', async () => {
      try {
        const data = encInput.value.trim();
        if (!data) return alert('Masukkan data enkripsi (base64) atau pilih file .enc');
        const pwd = decPassword.value;
        if (!pwd) return alert('Masukkan password untuk dekripsi');

        decryptBtn.disabled = true;
        decryptBtn.textContent = 'Decrypting...';

        const iterations = iterationsEl.value;
        const res = await decryptCombined(data, pwd, iterations);
        if (res.type === 'text') {
          decOutput.textContent = res.text;
          const blob = new Blob([res.text], {type:'text/plain'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = 'decrypted.txt';
          document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        } else if (res.type === 'file') {
          decOutput.textContent = 'File didekripsi: ' + res.filename;
          const blob = new Blob([res.arrayBuffer], {type: 'application/octet-stream'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = res.filename || 'decrypted.bin';
          document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        }
      } catch (e) {
        alert('Gagal dekripsi: ' + e.message);
      } finally {
        decryptBtn.disabled = false;
        decryptBtn.textContent = 'Decrypt';
      }
    });

    fileToEnc.addEventListener('change', () => {
      if (fileToEnc.files.length) plaintextEl.value = '';
    });
  </script>
</body>
</html>
